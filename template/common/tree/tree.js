/**
 * Created by luye on 10/12/2018.
 */
"use strict";function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(exports,"__esModule",{value:!0});var _slicedToArray=function(){function t(t,e){var a=[],r=!0,n=!1,i=void 0;try{for(var s,o=t[Symbol.iterator]();!(r=(s=o.next()).done)&&(a.push(s.value),!e||a.length!==e);r=!0);}catch(t){n=!0,i=t}finally{try{!r&&o.return&&o.return()}finally{if(n)throw i}}return a}return function(e,a){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return t(e,a);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),_createClass=function(){function t(t,e){for(var a=0;a<e.length;a++){var r=e[a];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,a,r){return a&&t(e.prototype,a),r&&t(e,r),e}}();require("./luyeJsonEditor.less");var _data=require("./data"),$=require("jquery"),cloneDeep=require("lodash.clonedeep"),loEach=require("lodash.foreach"),separator="-",relations=new Map,Tree=function(){function t(e){_classCallCheck(this,t),this.param={arrPartialLength:100},Object.assign(this.param,e),this.param.dom instanceof $||(this.param.dom=$(this.param.dom)),this.param.data||(this.param.data=_data.dataSource),this.init(),this.createDomBuilders(),this.render()}return _createClass(t,[{key:"init",value:function(){this.metadata=cloneDeep(this.param.data),this.layer=0,this.currentKey=""}},{key:"createDomBuilders",value:function(){this.rowBuilder=new Proxy({},{get:function(t,e){return"obj"==e?function(t,e,a,r){var n=t.attr("id");n=n&&0!==n?[n,e].join(separator):[t.parent().attr("id"),e].join(separator);var i=$('<div class="editor-row" id="'+n+'" type="obj" style="margin-left:'+24*r+'px" layer="'+r+'">\n                <button class="front-btn row-btn-obj">+</button><span class="editor-cell editor-cell-key">'+e+'</span><span class="editor-cell">{...}</span>\n                <button class="btn-add">ADD</button><button class="btn-del">DEL</button></div>');t.append(i),relations.set(n,a)}:"str"==e?function(t,e,a,r){var n=[t.attr("id"),e].join(separator),i=$('<div class="editor-row" id="'+n+'" type="str" style="margin-left:'+(24*r+24)+'px" layer="'+r+'">\n                <span class="editor-cell editor-cell-key">'+e+'</span><span class="editor-cell editor-cell-value">'+a+'</span>\n                <button class="btn-del">DEL</button></div>');t.append(i)}:"arr"==e?function(t,e,a,r){var n='[0-<span class="arr-len">'+a.length+"</span>]",i=t.attr("id");i=i&&0!==i?[i,e].join(separator):[t.parent().attr("id"),e].join(separator);var s=$('<div class="editor-row" id="'+i+'" type="arr" style="margin-left:'+24*r+'px" layer="'+r+'">\n                <button class="front-btn row-btn-arr">+</button><span class="editor-cell editor-cell-key">'+e+'</span><span class="editor-cell">'+n+'</span>\n                <button class="btn-add">ADD</button><button class="btn-del">DEL</button></div>');t.append(s),relations.set(i,a)}:void 0}})}},{key:"render",value:function(){this.container=$('<div class="editor-container" layer="0"><button class="btn-add" style="margin-left: 48px">ADD</button></div>'),this.renderJson(),this.renderBoard(),this.param.dom.html(this.container),this.attachEventsDelegation(),this.unfoldAttrs(this.param.layer)}},{key:"renderJson",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.metadata,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.container,a=this,r=Number.parseInt(e.attr("layer"));r++,loEach(t,function(t,n){("0"===e.attr("offset")||e.attr("offset"))&&(n+=Number.parseInt(e.attr("offset"))),t.constructor==Object?a.rowBuilder.obj(e,n,t,r):t.constructor==Array?a.rowBuilder.arr(e,n,t,r):a.rowBuilder.str(e,n,t,r)})}},{key:"renderBoard",value:function(){this.container.append('<div class="preview-board">'+JSON.stringify(this.metadata)+'</div><div class="json-dashboard">\n        <button class="btn-preview">PREVIEW</button><button class="btn-reset">RESET</button><button class="btn-submit">SUBMIT</button><div id="ctrl1"></div></div>'),this.attachSubmitEvent(this.container.find(".btn-submit")),this.attachPreviewEvent(),this.attachResetEvent()}},{key:"updateData",value:function(t){var e=t.data,a=void 0===e?this.metadata:e,r=t.keys,n=t.id,i=t.operation,s=t.key,o=t.value,l=t.isKey,d=void 0!==l&&l,c=r.length,u=cloneDeep(a);if("modify"==i)if(c<2)if(d){var p=a[r[0]];a[o]=p}else a[r[0]]=o;else this.updateData({data:a[r[0]],keys:r.splice(1),operation:i,isKey:d,value:o});else if("delete"==i)if(2==c){var b=_slicedToArray(r,2),h=b[0],v=b[1];if(a[h].constructor==Array){var f=Number.parseInt(v);delete a[h][f],a[h]=this.purifyArray(a[h])}else delete a[h][v]}else 1==c?(delete a[r[0]],a.constructor==Array&&(a=this.purifyArray(a))):this.updateData({data:a[r[0]],keys:r.splice(1),operation:i});else if("add"==i){if(!n)return void(a[s]=o);var y=n.split(separator),g=y.pop(),m=y.join(separator),k=void 0;k=void 0==m||0==m.length?this.metadata:relations.get(m),k[g].constructor==Array?k[g].push(o):k[g][s]=o}return console.log(this.metadata),console.log(this.param.data),u!==a}},{key:"updateAddedDom",value:function(t){if(t.hasClass("editor-container"))this.render();else{t.find(".btn-add").siblings(".adding-dom").toggle(),t.find(".front-btn").trigger("click"),t.find(".front-btn").trigger("click")}}},{key:"updateDeletedDom",value:function(t){if("arr"==t.parent().attr("type")){var e=Number.parseInt(t.find(".editor-cell-key").text()),a=t.parent().find(".arr-len").text();t.parent().find(".arr-len").text(Number.parseInt(a)-1),a=t.parent().parent().find(".arr-len")[0].innerHTML,t.parent().parent().find(".arr-len")[0].innerHTML=Number.parseInt(a)-1,Array.from(t.siblings(".editor-row")).filter(function(t){return Number.parseInt($(t).find(".editor-cell-key").text())>e}).map(function(t){var e=Number.parseInt($(t).find(".editor-cell-key").text())-1,a=$(t).attr("id").split(separator);a.pop(),a.push(e),$(t).attr("id",a.join(separator)),$(t).find(".editor-cell-key").text(e)})}t.remove()}},{key:"purifyArray",value:function(t){return t.filter(function(t){return void 0!=t&&null!=t})}},{key:"attachEventsDelegation",value:function(){var t=this;this.container.delegate("button.row-btn-obj","click",function(){var e=$(this).parent(),a="+"==$(this).text()?"-":"+";if($(this).text(a),"-"==a){var r=e.attr("id"),n=relations.get(r);t.renderJson(n,e)}else $(this).siblings(".editor-row").remove()}).delegate("button.row-btn-arr","click",function(){var e=$(this).parent(),a="+"==$(this).text()?"-":"+";if($(this).text(a),"-"==a){var r=e.attr("id");r||0===r||(r=e.attr("_id"));var n=relations.get(r),i=n.length,s=Number.parseInt(e.attr("layer"))+1;if(i>t.param.arrPartialLength)for(var o=0;o<i;o+=t.param.arrPartialLength){var l=r+o,d=o+t.param.arrPartialLength>i?i:o+t.param.arrPartialLength,c="["+o+'-<span class="arr-len">'+d+"</span>]";console.log(d),e.append('<div class="editor-row" _id="'+l+'" offset="'+o+'" type="arr" layer="'+s+'" style="padding-left:12px"><button class="front-btn row-btn-arr">+</button><span class="editor-cell">'+c+"</span></div>"),relations.set(l,n.slice(o,d))}else{var u=e.attr("id");u||0===u||(u=e.attr("_id"));var p=relations.get(u);t.renderJson(p,e)}}else $(this).siblings(".editor-row").remove()}).delegate("button.btn-add","click",function(){if($(this).siblings(".adding-dom").remove(),"arr"===$(this).parent().attr("type")){var t=$(this).parent().find(".arr-len")[0].innerHTML;$(this).before('<select class="adding-dom" onchange="this.parentNode.querySelectorAll(\'input\')[1].style.visibility = this.value !== \'str\'?\'hidden\':\'visible\'"><option selected value="str">String</option><option value="arr">Array</option><option value="obj">Object</option></select>\n            <input class="adding-dom" value="'+t+'" readonly/><input class="adding-dom" autofocus/>\n            <button class="btn-adding adding-dom">确定</button><button class="btn-cancel adding-dom">取消</button>')}else $(this).before('<select class="adding-dom" onchange="this.parentNode.querySelectorAll(\'input\')[1].style.visibility = this.value !== \'str\'?\'hidden\':\'visible\'"><option selected value="str">String</option><option value="arr">Array</option><option value="obj">Object</option></select>\n            <input class="adding-dom" autofocus/><input class="adding-dom"/>\n            <button class="btn-adding adding-dom">确定</button><button class="btn-cancel adding-dom">取消</button>');$(this).toggle().next().toggle()}).delegate("button.btn-cancel","click",function(){$(this).parent().children(".adding-dom").toggle(),$(this).siblings(".btn-add").toggle(),$(this).siblings(".btn-del").toggle()}).delegate("button.btn-adding","click",function(){var e=this,a=$(this).parent(),r=$(this).prev().val();"arr"==$(this).siblings("select").val()?r=[]:"obj"==$(this).siblings("select").val()&&(r={});var n=$(this).prev().prev().val(),i=a.attr("id");try{i=i.split(separator).splice(1)}catch(t){i=[]}""!=$.trim(n)&&new Promise(function(s){t.updateData({id:a.attr("id"),operation:"add",keys:i,key:n,value:r})&&($(e).siblings(".btn-add").toggle().siblings(".btn-del").toggle(),s())}).then(t.updateAddedDom(a,n,r,"+"===$(this).siblings(".front-btn").text()))}).delegate("button.btn-del","click",function(){var e=$(this).parent();new Promise(function(a,r){t.updateData({id:e.attr("id"),keys:e.attr("id").split(separator).splice(1),operation:"delete"})?a():alert("deleting fails")}).then(t.updateDeletedDom(e))}).delegate('span[class*="editor-cell-"]',"dblclick",function(){var t=void 0;$(this).has("input").length||(t=$(this).text(),$(this).html('<input value="'+t+'" autofocus/><button class="btn-modify">确定</button><button class="btn-modify-cancel">取消</button>').addClass("transparent"))}).delegate(".btn-modify","click",function(){var e=$(this).prev().val(),a=$(this).parent();a.html(e).removeClass("transparent"),t.updateData({keys:a.closest("div").attr("id").split(separator).splice(1),operation:"modify",value:e,isKey:a.hasClass("editor-cell-key")})}).delegate(".btn-modify-cancel","click",function(){var t=this.previousSibling.previousSibling.value;$(this).parent().html(t).removeClass("transparent")})}},{key:"attachSubmitEvent",value:function(t){var e=this;t.click(function(){return console.log(e.metadata)})}},{key:"attachPreviewEvent",value:function(){var t=this;this.container.find(".btn-preview").click(function(){return $(".preview-board").text(JSON.stringify(t.metadata)).toggle(500)})}},{key:"attachResetEvent",value:function(){var t=this;this.container.find(".btn-reset").click(function(){t.metadata=cloneDeep(t.param.data),t.render()})}},{key:"unfoldAttrs",value:function(){for(var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:3,e=1;e<=t;e++)this.container.find('.editor-row[layer="'+e+'"] button.front-btn').trigger("click")}},{key:"destroy",value:function(){this.param.el.empty()}}]),t}();exports.default=Tree;